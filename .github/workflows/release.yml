name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Is this a prerelease?'
        type: boolean
        default: false

jobs:
  release:
    name: Create Release Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install NDK
        run: |
          sdkmanager "ndk;25.2.9519653" "cmake;3.22.1"

      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Create Release Package
        run: |
          mkdir -p release-package
          cp app/build/outputs/apk/release/app-release-unsigned.apk release-package/
          cp README.md release-package/
          
          # Create checksum
          cd release-package
          sha256sum app-release-unsigned.apk > checksum.txt
          
          # Create version info
          echo "GGUF Model Surgeon" > version.txt
          echo "Version: ${{ github.event.inputs.version }}" >> version.txt
          echo "Build Date: $(date)" >> version.txt
          echo "Commit: ${{ github.sha }}" >> version.txt

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gguf-surgeon-${{ github.event.inputs.version }}
          path: release-package/
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          body: |
            ## GGUF Model Surgeon ${{ github.event.inputs.version }}
            
            ### ‚ö†Ô∏è IMPORTANT: Unsigned APK
            This release contains an **unsigned APK**. You must sign it before installation or enable developer options and allow unsigned installations.
            
            ### üì¶ What's Included:
            - `app-release-unsigned.apk` - Unsigned release APK
            - `checksum.txt` - SHA256 checksums
            - `version.txt` - Version information
            
            ### üîß How to Install:
            1. Download the APK
            2. Sign it with your own keystore, OR
            3. Enable "Install unknown apps" and "Allow unsigned installations" in developer options
            
            ### ‚ú® Features:
            - Real GGUF binary parser
            - LoRA adapter merging
            - Model quantization (Q2_K through Q8_0)
            - Metadata editing
            - GGUF v3 validation
            
            ### üì± Requirements:
            - Android 8.0+ (API 26+)
            - ARM64 or x86_64 device
            - ~100MB free space for native libs
          files: |
            release-package/app-release-unsigned.apk
            release-package/checksum.txt
            release-package/version.txt
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
